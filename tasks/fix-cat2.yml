---
### RHEL-07-010030 | RHEL-07-010040 combined as related tasks in regards to a config file no other content will be in.
- name: "MEDIUM | RHEL-07-010030 | RHEL-07-010040 | PATCH | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  copy:
      dest: /etc/dconf/db/local.d/01-banner-message
      content: |
          [org/gnome/login-screen]
          banner-message-enable=true
          banner-message-text='{{ rhel7stig_logon_banner | replace(newline, "\n") }}'
      mode: '0644'
  vars:
      newline: "\n"
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010030
      - rhel_07_010040
  tags:
      - RHEL-07-010030
      - RHEL_07_010040
      - dod_logon_banner
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010050 | PATCH | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a command line user logon."
  copy:
      content: "{{ rhel7stig_logon_banner }}"
      dest: "{{ item }}"
      owner: root
      group: root
      mode: 0644
  when:
      - rhel_07_010050
      - rhel7stig_ssh_required
  with_items:
      - /etc/issue
      - /etc/issue.net
  tags:
      - RHEL-07-010050
      - ssh
      - dod_logon_banner

- name: "MEDIUM | RHEL-07-010060 | PATCH | The Red Hat Enterprise Linux operating system must enable a user session lock until that user re-establishes access using established identification and authentication procedures."
  copy:
      dest: /etc/dconf/db/local.d/00-screensaver_rhel_07_010060
      content: |
        [org/gnome/desktop/screensaver]
        lock-enabled=true
      mode: '0644'
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010060
  tags:
      - RHEL-07-010060
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010061 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate users using multifactor authentication via a graphical user logon."
  copy:
      dest: /etc/dconf/db/local.d/00-defaults_rhel_07_010061
      content: |
          [org/gnome/login-screen]
          enable-smartcard-authentication=true
      mode: '0644'
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010061
  tags:
      - RHEL-07-010061
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010062 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-enabled setting for the graphical user interface."
  copy:
      dest: /etc/dconf/db/local.d/locks/session_rhel_07_010062
      content: |
          /org/gnome/desktop/screensaver/lock-enabled
      mode: '0644'
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010062
  tags:
      - RHEL-07-010062
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010070 | PATCH | The Red Hat Enterprise Linux operating system must initiate a screensaver after a 15-minute period of inactivity for graphical user interfaces."
  copy:
      dest: /etc/dconf/db/local.d/00-screensaver_rhel_07_010070
      content: |
          [org/gnome/desktop/session]
          idle-delay=uint32 900
      mode: '0644'
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010070
  tags:
      - RHEL-07-010070
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010081 | PATCH | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-delay setting for the graphical user interface."
  copy:
      dest: /etc/dconf/db/local.d/locks/session_rhel_07_010081
      content: |
          /org/gnome/desktop/screensaver/lock-delay
      mode: '0644'
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010081
  tags:
      - RHEL-07-010081
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010082 | PATCH | The Red Hat Enterprise Linux operating system must prevent a user from overriding the session idle-delay setting for the graphical user interface."
  copy:
      dest: /etc/dconf/db/local.d/locks/session_rhel_07_010082
      content: |
          /org/gnome/desktop/session/idle-delay
      mode: '0644'
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010082
  tags:
      - RHEL-07-010082
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010090 | The Red Hat Enterprise Linux operating system must have the screen package installed."
  block:
      - name: "MEDIUM | RHEL-07-010090 | AUDIT | The Red Hat Enterprise Linux operating system must have the screen package installed. Check for screen or tmux"
        command: rpm -q screen tmux
        args:
            warn: no
        check_mode: no
        register: rhel_07_010090_audit
        changed_when: rhel_07_010090_audit.rc > 1
        failed_when: no

      - name: "MEDIUM | RHEL-07-010090 | PATCH | The Red Hat Enterprise Linux operating system must have the screen package installed."
        yum:
            name: "{{ rhel7stig_screen_package }}"
            state: present
        when:
            - rhel_07_010090_audit is changed or
              rhel7stig_force_exact_packages
  when: rhel_07_010090
  tags:
      - RHEL-07-010090

- name: "MEDIUM | RHEL-07-010100 | PATCH | The Red Hat Enterprise Linux operating system must initiate a session lock for the screensaver after a period of inactivity for graphical user interfaces."
  copy:
      dest: /etc/dconf/db/local.d/00-screensaver_rhel_07_010100
      content: |
          [org/gnome/desktop/screensaver]
          idle-activation-enabled=true
      mode: '0644'
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010100
  tags:
      - RHEL-07-010100
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010101 | PATCH | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver idle-activation-enabled setting for the graphical user interface."
  copy:
      dest: /etc/dconf/db/local.d/locks/session_rhel_07_010101
      content: |
          /org/gnome/desktop/screensaver/idle-activation-enabled
      mode: '0644'
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010101
  tags:
      - RHEL-07-010101
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010110 | PATCH | The Red Hat Enterprise Linux operating system must initiate a session lock for graphical user interfaces when the screensaver is activated."
  copy:
      dest: /etc/dconf/db/local.d/00-screensaver_rhel_07_010110
      content: |
          [org/gnome/desktop/screensaver]
          lock-delay=uint32 5
      mode: '0644'
  notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_010110
  tags:
      - RHEL-07-010110
      - dconf
      - gui

- name: "MEDIUM | RHEL-07-010119 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used."
  lineinfile:
      create: yes
      dest: /etc/pam.d/system-auth
      regexp: '^#?password required pam_pwquality.so retry'
      line: password required pam_pwquality.so retry=3
  when: rhel_07_010119
  tags:
      - RHEL-07-010119
      - pamd

- name: "MEDIUM | RHEL-07-010120 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one upper-case character."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*ucredit'
      line: "ucredit = {{ rhel7stig_password_complexity.ucredit | default('-1') }}"
  when: rhel_07_010120
  tags:
      - RHEL-07-010120
      - pwquality

- name: "MEDIUM | RHEL-07-010130 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one lower-case character."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*lcredit'
      line: "lcredit = {{ rhel7stig_password_complexity.lcredit | default('-1') }}"
  when: rhel_07_010130
  tags:
      - RHEL-07-010130
      - pwquality

- name: "MEDIUM | RHEL-07-010140 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are assigned, the new password must contain at least one numeric character."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*dcredit'
      line: "dcredit = {{ rhel7stig_password_complexity.dcredit | default('-1') }}"
  when: rhel_07_010140
  tags:
      - RHEL-07-010140
      - pwquality

- name: "MEDIUM | RHEL-07-010150 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one special character."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*ocredit'
      line: "ocredit = {{ rhel7stig_password_complexity.ocredit | default('-1') }}"
  when: rhel_07_010150
  tags:
      - RHEL-07-010150
      - pwquality

- name: "MEDIUM | RHEL-07-010160 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of eight of the total number of characters must be changed."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*difok'
      line: "difok = {{ rhel7stig_password_complexity.difok | default('8') }}"
  when: rhel_07_010160
  tags:
      - RHEL-07-010160
      - pwquality

- name: "MEDIUM | RHEL-07-010170 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of four character classes must be changed."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*minclass'
      line: "minclass = {{ rhel7stig_password_complexity.minclass | default('4') }}"
  when: rhel_07_010170
  tags:
      - RHEL-07-010170
      - pwquality

- name: "MEDIUM | RHEL-07-010180 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating consecutive characters must not be more than three characters."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*maxrepeat'
      line: "maxrepeat = {{ rhel7stig_password_complexity.maxrepeat | default('3') }}"
  when: rhel_07_010180
  tags:
      - RHEL-07-010180
      - pwquality

- name: "MEDIUM | RHEL-07-010190 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating characters of the same character class must not be more than four characters."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*maxclassrepeat'
      line: "maxclassrepeat = {{ rhel7stig_password_complexity.maxclassrepeat | default('4') }}"
  when: rhel_07_010190
  tags:
      - RHEL-07-010190
      - pwquality

- name: "MEDIUM | RHEL-07-010200 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the PAM system service is configured to store only encrypted representations of passwords."
  pamd:
      name: "{{ item[0] }}"
      state: "{{ item[1].state }}"
      type: password
      control: sufficient
      module_path: pam_unix.so
      module_arguments: "{{ item[1].args }}"
  with_nested:
      - [ 'system-auth', 'password-auth' ]
      -
          - state: args_present
            args:
                - "sha512"
          - state: args_absent
            args:
                - "md5"
                - "bigcrypt"
                - "sha256"
                - "blowfish"
  when: rhel_07_010200
  tags:
      - RHEL-07-010200
      - pamd

- name: "MEDIUM | RHEL-07-010210 | PATCH | The Red Hat Enterprise Linux operating system must be configured to use the shadow file to store only encrypted representations of passwords."
  lineinfile:
      dest: /etc/login.defs
      regexp: ^#?ENCRYPT_METHOD
      line: "ENCRYPT_METHOD {{ rhel7stig_login_defaults.encrypt_method | default('SHA512') }}"
  when: rhel_07_010210
  tags:
      - RHEL-07-010210
      - login

- name: "MEDIUM | RHEL-07-010220 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that user and group account administration utilities are configured to store only encrypted representations of passwords."
  lineinfile:
      dest: /etc/libuser.conf
      regexp: ^#?crypt_style
      line: crypt_style = sha512
  when: rhel_07_010220
  tags:
      - RHEL-07-010220

- name: "MEDIUM | RHEL-07-010230 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 24 hours/1 day minimum lifetime."
  lineinfile:
      create: yes
      dest: /etc/login.defs
      regexp: ^#?PASS_MIN_DAYS
      line: "PASS_MIN_DAYS {{ rhel7stig_login_defaults.pass_min_days | default('1') }}"
  when: rhel_07_010230
  tags:
      - RHEL-07-010230
      - login

- name: "MEDIUM | RHEL-07-010240 | The Red Hat Enterprise Linux operating system must be configured so that passwords are restricted to a 24 hours/1 day minimum lifetime."
  block:
      - name: "MEDIUM | RHEL-07-010240 | AUDIT | Passwords must be restricted to a 24 hours/1 day minimum lifetime."
        command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $4 < 1 {print $1}' /etc/shadow"
        check_mode: no
        changed_when: no
        register: rhel_07_010240_audit

      - name: "MEDIUM | RHEL-07-010240 | PATCH | Passwords must be restricted to a 24 hours/1 day minimum lifetime."
        command: chage -m 1 {{ item }}
        with_items: "{{ rhel_07_010240_audit.stdout_lines }}"
  when: rhel_07_010240
  tags:
      - RHEL-07-010240
      - password

- name: "MEDIUM | RHEL-07-010250 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 60-day maximum lifetime."
  lineinfile:
      create: yes
      dest: /etc/login.defs
      regexp: ^#?PASS_MAX_DAYS
      line: "PASS_MAX_DAYS {{ rhel7stig_login_defaults.pass_max_days | default('60') }}"
  when: rhel_07_010250
  tags:
      - RHEL-07-010250
      - login

- name: "MEDIUM | RHEL-07-010260 | The Red Hat Enterprise Linux operating system must be configured so that existing passwords are restricted to a 60-day maximum lifetime."
  block:
      - name: "MEDIUM | RHEL-07-010260 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that existing passwords are restricted to a 60-day maximum lifetime."
        command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $5 > 60 {print $1}' /etc/shadow"
        check_mode: no
        changed_when: rhel_07_010260_audit.stdout != ""
        register: rhel_07_010260_audit

      - name: "MEDIUM | RHEL-07-010260 | PATCH | Reset password timeout to prevent locking out user."
        command: chage -d '-1 day' {{ item }}
        check_mode: "{{ rhel7stig_disruptive_check_mode }}"
        with_items: "{{ rhel_07_010260_audit.stdout_lines }}"

      - name: "MEDIUM | RHEL-07-010260 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that existing passwords are restricted to a 60-day maximum lifetime."
        command: chage -M 60 {{ item }}
        check_mode: "{{ rhel7stig_disruptive_check_mode }}"
        with_items: "{{ rhel_07_010260_audit.stdout_lines }}"
  when:
      - rhel_07_010260
      - rhel7stig_disruptive
  tags:
      - RHEL-07-010260
      - disruption-high
      - password

- name: "MEDIUM | RHEL-07-010270 | The Red Hat Enterprise Linux operating system must be configured so that passwords are prohibited from reuse for a minimum of five generations."
  block:
      - name: "MEDIUM | RHEL-07-010270 | PATCH | Ensure pam_pwhistory rule exists"
        pamd:
            name: "{{ item }}"
            state: before
            type: password
            control: sufficient
            module_path: pam_unix.so
            new_type: password
            new_control: requisite
            new_module_path: pam_pwhistory.so
        with_items:
            - "system-auth"
            - "password-auth"

      # TODO: Remove temporary audit check to determine if the following pamd module task needs to be run since the module is not idempotent
      - name: "MEDIUM | RHEL-07-010270 | AUDIT | Check for existing password history reuse settings"
        command: "grep -iE '^password\\s+requisite\\s+pam_pwhistory.so\\s+use_authtok\\s+remember={{ rhel7stig_pam_pwhistory.remember | default(5) }}\\s+retry={{ rhel7stig_pam_pwhistory.retries | default(3) }}$' /etc/pam.d/{{ item }}"
        check_mode: no
        changed_when: no
        failed_when: rhel_07_010270_audit.rc > 1
        register: rhel_07_010270_audit
        with_items:
            - "system-auth"
            - "password-auth"

      # TODO: Once the pamd module is fixed (either args_present or updated) then remove the previous grep task and update the following.
      - name: "MEDIUM | RHEL-07-010270 | PATCH | Ensure pam_pwhistory module arguments are set"
        pamd:
            name: "{{ item.item }}"
            state: updated
            type: password
            control: requisite
            module_path: pam_pwhistory.so
            module_arguments:
                - use_authtok
                - remember={{ rhel7stig_pam_pwhistory.remember | default(5) }}
                - retry={{ rhel7stig_pam_pwhistory.retries | default(3) }}
        with_items: "{{ rhel_07_010270_audit.results }}"
        when: item.rc == 1

  when: rhel_07_010270
  tags:
      - RHEL-07-010270
      - pamd

- name: "MEDIUM | RHEL-07-010280 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that passwords are a minimum of 15 characters in length."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*minlen'
      line: "minlen = {{ rhel7stig_password_complexity.minlen | default('15') }}"
  when: rhel_07_010280
  tags:
      - RHEL-07-010280
      - pwquality

- name: "MEDIUM | RHEL-07-010310 | PATCH | The Red Hat Enterprise Linux operating system must disable account identifiers (individuals, groups, roles, and devices) if the password expires."
  lineinfile:
      dest: /etc/default/useradd
      regexp: ^#?INACTIVE
      line: INACTIVE=0
  when: rhel_07_010310
  tags:
      - RHEL-07-010310

- name: |
        "MEDIUM | RHEL-07-010320 | Accounts on the Red Hat Enterprise Linux operating system that are subject to three unsuccessful logon attempts within 15 minutes must be locked for the maximum configurable period."
        "MEDIUM | RHEL-07-010330 | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
  block:
      - name: |
              "MEDIUM | RHEL-07-010320 | PATCH | Accounts on the Red Hat Enterprise Linux operating system that are subject to three unsuccessful logon attempts within 15 minutes must be locked for the maximum configurable period."
              "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
        pamd:
            name: "{{ item }}"
            state: before
            type: auth
            control: sufficient
            module_path: pam_unix.so
            new_type: auth
            new_control: required
            new_module_path: pam_faillock.so
        with_items:
            - "system-auth"
            - "password-auth"

      # TODO: Remove temporary audit check to determine if the following pamd module task needs to be run since the module is not idempotent
      - name: |
              "MEDIUM | RHEL-07-010320 | AUDIT | Check for existing account lockout settings"
              "MEDIUM | RHEL-07-010330 | AUDIT | Check for existing account lockout settings"
        command: "grep -iE '^auth\\s+required\\s+pam_faillock.so\\s+preauth\\s+silent\\s+audit\\s+deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }}\\s+unlock_time={{ rhel7stig_pam_faillock.unlock_time }}$' /etc/pam.d/{{ item }}"
        check_mode: no
        changed_when: no
        failed_when: rhel_07_010320_010330_preauth_audit.rc > 1
        register: rhel_07_010320_010330_preauth_audit
        with_items:
            - "system-auth"
            - "password-auth"

      # TODO: Once the pamd module is fixed (either args_present or updated) then remove the previous grep task and update the following.
      - name: |
              "MEDIUM | RHEL-07-010320 | PATCH | Accounts on the Red Hat Enterprise Linux operating system that are subject to three unsuccessful logon attempts within 15 minutes must be locked for the maximum configurable period."
              "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
        pamd:
            name: "{{ item.item }}"
            state: updated
            type: auth
            control: required
            module_path: pam_faillock.so
            module_arguments: "preauth silent audit deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }} unlock_time={{ rhel7stig_pam_faillock.unlock_time }}"
        with_items: "{{ rhel_07_010320_010330_preauth_audit.results }}"
        when: item.rc == 1

      - name: "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
        pamd:
            name: "{{ item }}"
            state: before
            type: auth
            control: required
            module_path: pam_deny.so
            new_type: auth
            new_control: "[default=die]"
            new_module_path: pam_faillock.so
        with_items:
            - "system-auth"
            - "password-auth"

      # TODO: Remove temporary audit check to determine if the following pamd module task needs to be run since the module is not idempotent
      - name: "MEDIUM | RHEL-07-010330 | AUDIT | Check for existing account lockout settings"
        command: "grep -iE '^auth\\s+\\[default=die\\]\\s+pam_faillock.so\\s+authfail\\s+audit\\s+deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }}\\s+unlock_time={{ rhel7stig_pam_faillock.unlock_time }}$' /etc/pam.d/{{ item }}"
        check_mode: no
        changed_when: no
        failed_when: rhel_07_010330_authfail_audit.rc > 1
        register: rhel_07_010330_authfail_audit
        with_items:
            - "system-auth"
            - "password-auth"

      # TODO: Once the pamd module is fixed (either args_present or updated) then remove the previous grep task and update the following.
      - name: "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
        pamd:
            name: "{{ item.item }}"
            state: updated
            type: auth
            control: "[default=die]"
            module_path: pam_faillock.so
            module_arguments: "authfail audit deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }} unlock_time={{ rhel7stig_pam_faillock.unlock_time }}"
        with_items: "{{ rhel_07_010330_authfail_audit.results }}"
        when: item.rc == 1

      - name: "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
        pamd:
            name: "{{ item }}"
            state: before
            type: account
            control: required
            module_path: pam_unix.so
            new_type: account
            new_control: required
            new_module_path: pam_faillock.so
        with_items:
            - "system-auth"
            - "password-auth"

  when: rhel_07_010320 or rhel_07_010330
  tags:
      - RHEL-07-010320
      - RHEL-07-010330
      - pamd

- name: "MEDIUM | RHEL-07-010340 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that users must provide a password for privilege escalation."
  replace:
      path: "{{ item }}"
      regexp: '^([^#].*)NOPASSWD(.*)'
      replace: '\1PASSWD\2'
      validate: '/usr/sbin/visudo -cf %s'
  with_items: "{{ rhel7stig_sudoers_files.stdout_lines }}"
  when:
      - rhel7stig_using_password_auth
      - rhel_07_010340
  tags:
      - RHEL-07-010340
      - sudoers

- name: "MEDIUM | RHEL-07-010350 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that users must re-authenticate for privilege escalation."
  replace:
      path: "{{ item }}"
      regexp: '^([^#].*)!authenticate(.*)'
      replace: '\1authenticate\2'
      validate: '/usr/sbin/visudo -cf %s'
  with_items: "{{ rhel7stig_sudoers_files.stdout_lines }}"
  when: rhel_07_010350
  tags:
      - RHEL-07-010350
      - sudoers

- name: "MEDIUM | RHEL-07-010430 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the delay between logon prompts following a failed console logon attempt is at least four seconds."
  lineinfile:
      dest: /etc/login.defs
      regexp: ^#?FAIL_DELAY
      line: "FAIL_DELAY {{ rhel7stig_login_defaults.fail_delay_secs | default('4') }}"
  when: rhel_07_010430
  tags:
      - RHEL-07-010430
      - login

- name: "MEDIUM | RHEL-07-010460 | PATCH | The Red Hat Enterprise Linux operating system must not allow users to override SSH environment variables."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?PermitUserEnvironment"
      line: PermitUserEnvironment no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_010460
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-010460
      - ssh

- name: "MEDIUM | RHEL-07-010470 | PATCH | The Red Hat Enterprise Linux operating system must not allow a non-certificate trusted host SSH logon to the system."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?HostbasedAuthentication"
      line: HostbasedAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-010470
      - ssh

# TODO: A user can still override the authentication requirement for single user mode in a couple ways that the STIG misses.
# This fix block does not check for those methods. i.e.
# User can override the rescue.service unit by placing a copy at /etc/systemd/system/rescue.service
# User can override some settings of the rescue.service unit by placing the overridden lines in /etc/systemd/system/rescue.service.d/override.conf
# Additionally the user can provide the -e or --force options to /usr/sbin/sulogin which will provide a root shell without password if the
# password file is inaccessbile or the root password is non-existent, LOCKED, or damaged.
- name: "MEDIUM | RHEL-07-010481 | The Red Hat Enterprise Linux operating system must require authentication upon booting into single-user and maintenance modes."
  block:
      - name: "MEDIUM | RHEL-07-010481 | PATCH | Check if the packaged rescue.service file was edited directly"
        shell: "cat /usr/lib/systemd/system/rescue.service | grep 'ExecStart=.*sulogin'"
        changed_when: no
        failed_when: no
        check_mode: no
        register: systemd_rescue_unit_check

      - name: "MEDIUM | RHEL-07-010481 | PATCH | Force reinstall systemd package to replace edited /usr/lib/systemd/system/rescue.service"
        shell: yum -y reinstall systemd
        when: systemd_rescue_unit_check.rc == 1
  when: rhel_07_010481
  tags:
      - RHEL-07-010481
      - rescue

- name: "MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication."
  command: "true"
  changed_when: no
  when: rhel_07_010500
  tags:
      - RHEL-07-010500
      - notimplemented

- name: "MEDIUM | RHEL-07-020020 | PATCH | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
  command: "true"
  changed_when: no
  when: rhel_07_020020
  tags:
      - RHEL-07-020020
      - notimplemented

- name: |
        "MEDIUM | RHEL-07-020030 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that a file integrity tool verifies the baseline operating system configuration at least weekly."
        "MEDIUM | RHEL-07-020040 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that designated personnel are notified if baseline configurations are changed in an unauthorized manner."
  cron:
      name: 'Run AIDE integrity check {{ rhel7stig_aide_cron.special_time }}'
      user: "{{ rhel7stig_aide_cron.user }}"
      cron_file: "{{ rhel7stig_aide_cron.cron_file }}"
      job: "{{ rhel7stig_aide_cron.job + ((rhel7stig_aide_cron.notify_by_mail) | ternary(rhel7stig_aide_cron.notify_cmd,'')) }}"
      minute: "{{ rhel7stig_aide_cron.minute | default((rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['hourly', 'daily', 'weekly', 'monthly']) |
              ternary('0', omit)) | default(omit) }}"
      hour: "{{ rhel7stig_aide_cron.hour | default((rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['daily', 'weekly', 'monthly']) |
              ternary('0', omit)) | default(omit) }}"
      weekday: "{{ rhel7stig_aide_cron.weekday | default((rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['weekly']) |
              ternary('0', omit)) | default(omit) }}"
      day: "{{ rhel7stig_aide_cron.day | default((rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['monthly']) |
              ternary('1', omit)) | default(omit) }}"
      special_time: "{{ (rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['hourly', 'daily', 'weekly', 'monthly']) |
              ternary(omit, rhel7stig_aide_cron.special_time) }}"
  when: rhel_07_020030 or rhel_07_020040
  tags:
      - RHEL-07-020030
      - RHEL-07-020040
      - aide

- name: "MEDIUM | RHEL-07-020100 | PATCH | The Red Hat Enterprise Linux operating system must be configured to disable USB mass storage."
  lineinfile:
      dest: /etc/modprobe.d/blacklist.conf
      insertafter: "{{ item.insertafter }}"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      create: yes
      owner: root
      group: root
      mode: "0644"
  with_items:
      - insertafter: "^#blacklist usb-storage(\\s+|$)"
        regexp: "^blacklist usb-storage(\\s+|$)"
        line: 'blacklist usb-storage'
      - insertafter: "^#install usb-storage"
        regexp: "^install usb-storage"
        line: install usb-storage /bin/true
  when: rhel_07_020100
  tags:
      - RHEL-07-020100
      - usb_devices

- name: "MEDIUM | RHEL-07-020101 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the Datagram Congestion Control Protocol (DCCP) kernel module is disabled unless required."
  lineinfile:
      dest: /etc/modprobe.d/nodccp.conf
      insertafter: "{{ item.insertafter }}"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      create: yes
      owner: root
      group: root
      mode: "0644"
  with_items:
      - insertafter: ^#blacklist dccp
        regexp: ^blacklist dccp(\s+|$)
        line: blacklist dccp
      - insertafter: ^#install dccp
        regexp: "^install dccp "
        line: install dccp /bin/true
  when: rhel_07_020101
  tags:
      - RHEL-07-020101
      - dccp

- name: "MEDIUM | RHEL-07-020110 | PATCH | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
  shell: "systemctl show autofs | grep LoadState | cut -d = -f 2"
  register: rhel_07_020110_autofs_service_status
  changed_when: no
  check_mode: no
  when:
      - rhel_07_020110
  tags:
      - RHEL-07-020110

- name: "MEDIUM | RHEL-07-020110 | PATCH | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
  service:
      name: autofs
      enabled: no
      state: stopped
  when:
      - rhel_07_020110
      - rhel_07_020110_autofs_service_status.stdout == "loaded"
      - not rhel7stig_autofs_required
  tags:
      - RHEL-07-020110


- name: "MEDIUM | RHEL-07-020111 | The Red Hat Enterprise Linux operating system must disable the graphical user interface automounter unless required."
  block:
      - name: "MEDIUM | RHEL-07-020111 | The Red Hat Enterprise Linux operating system must disable the graphical user interface automounter unless required."
        copy:
            dest: /etc/dconf/db/local.d/00-no-automount_rhel_07_010111
            content: |
                [org/gnome/desktop/media-handling]
                automount=false
                automount-open=false
                autorun-never=true
            mode: '0644'
        notify: dconf update

      - name: "MEDIUM | RHEL-07-020111 | The Red Hat Enterprise Linux operating system must disable the graphical user interface automounter unless required."
        copy:
            dest: /etc/dconf/db/local.d/locks/00-no-automount_rhel_07_010111
            # not sure if comments are allowed in the files, so here:
            # /org/gnome/desktop/media-handling/automount-open
            # Whether to automatically open a folder for automounted media
            # /org/gnome/desktop/media-handling/automount
            # Whether to automatically mount media
            # /org/gnome/desktop/media-handling/autorun-never
            # Never prompt or autorun/autostart programs when media are inserted
            content: |
                /org/gnome/desktop/media-handling/automount
                /org/gnome/desktop/media-handling/automount-open
                /org/gnome/desktop/media-handling/autorun-never
            mode: '0644'
        notify: dconf update
  when:
      - rhel7stig_dconf_available
      - rhel_07_020111
  tags:
      - RHEL-07-020111
      - dconf
      - gui


- name: "MEDIUM | RHEL-07-020240 | PATCH | The Red Hat Enterprise Linux operating system must define default permissions for all authenticated users in such a way that the user can only read and modify their own files."
  lineinfile:
      dest: /etc/login.defs
      regexp: ^#?UMASK
      line: "UMASK {{ rhel7stig_login_defaults.umask | default('077') }}"
  when: rhel_07_020240
  tags:
      - RHEL-07-020240
      - login
      - umask


- name: "MEDIUM | RHEL-07-020260 | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date."
  yum:
      name: '*'
      state: latest
  when: rhel_07_020260
  tags:
      - RHEL-07-020260
      - packaging

- name: "MEDIUM | RHEL-07-020260 | AUDIT | Check if yum-cron is installed"
  command: rpm -q yum-cron
  check_mode: no
  changed_when: no
  failed_when: no
  args:
      warn: no
  register: rhel_07_020260_yum_cron_installed
  when: rhel_07_020260
  tags:
      - RHEL-07-020260
      - packaging

- name: "MEDIUM | RHEL-07-020260 | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date."
  block:
      - name: "MEDIUM | RHEL-07-020260 | AUDIT | Check RHEL type"
        command: rpm -q redhat-release-workstation
        check_mode: no
        changed_when: no
        failed_when: no
        args:
            warn: false
        register: rhel_07_020260_rhel_type

      - block:
            - name: "MEDIUM | RHEL-07-020260 | PATCH | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date. | Install yum-cron"
              yum:
                  name: yum-cron
                  state: "{{ (rhel7stig_auto_package_updates.enabled) | ternary('present','absent') }}"
        rescue:
            - name: "MEDIUM | RHEL-07-020260 | PATCH | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date. | Install yum-cron"
              block:
                  - name: "MEDIUM | RHEL-07-020260 | PATCH | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date. | Install yum-cron"
                    yum:
                        name: yum-cron
                        state: "{{ (rhel7stig_auto_package_updates.enabled) | ternary('present','absent') }}"
                        enablerepo: "{{ 'rhel-7-' ~ (rhel_07_020260_rhel_type.rc == 0) |
                                ternary('workstation', 'server') ~ '-optional-rpms' }}"

              rescue:
                  # Might be an AWS RHEL instance, try it...
                  - name: "MEDIUM | RHEL-07-020260 | PATCH | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date. | Install yum-cron"
                    yum:
                        name: yum-cron
                        state: "{{ (rhel7stig_auto_package_updates.enabled) | ternary('present','absent') }}"
                        enablerepo: rhui-REGION-rhel-server-optional

      - name: "MEDIUM | RHEL-07-020260 | PATCH | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date. | Verify yum-cron config file exists"
        stat:
            path: "/etc/yum/yum-cron{{ (rhel7stig_auto_package_updates.frequency == 'hourly') | ternary('-hourly','') }}.conf"
        check_mode: no
        register: yum_cron_config_file

      - name: "MEDIUM | RHEL-07-020260 | PATCH | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date. | Enable/disable automatic updates in the appropriate yum-cron.conf file."
        lineinfile:
            dest: "/etc/yum/yum-cron{{ (rhel7stig_auto_package_updates.frequency == 'hourly') | ternary('-hourly','') }}.conf"
            regexp: "^apply_updates"
            line: "apply_updates = {{ (rhel7stig_auto_package_updates.enabled) | ternary('yes','no') }}"
            state: present
        when: yum_cron_config_file.stat.exists

      - name: "MEDIUM | RHEL-07-020260 | PATCH | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date. | Set update command to configured setting."
        lineinfile:
            dest: "/etc/yum/yum-cron{{ (rhel7stig_auto_package_updates.frequency == 'hourly') | ternary('-hourly','') }}.conf"
            regexp: "^update_cmd"
            line: "update_cmd = {{ rhel7stig_auto_package_updates.update_cmd | default('minimal-security') }}"
            state: present
        when: yum_cron_config_file.stat.exists

      - name: "MEDIUM | RHEL-07-020260 | PATCH | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date. | Verify the yum-cron service exists"
        shell: "systemctl show yum-cron | grep LoadState | cut -d = -f 2"
        register: rhel_07_020260_yumcron_service_status
        changed_when: no
        check_mode: no

      - name: "MEDIUM | RHEL-07-020260 | PATCH | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date. | Set the yum-cron service state"
        service:
            name: yum-cron
            enabled: "{{ rhel7stig_auto_package_updates.enabled }}"
            state: "{{ (rhel7stig_auto_package_updates.enabled) | ternary(rhel7stig_service_started, 'stopped') }}"
        when: rhel_07_020260_yumcron_service_status.stdout == "loaded"

  when:
      - rhel_07_020260
      - rhel7stig_auto_package_updates_enabled or
        rhel_07_020260_yum_cron_installed.rc == 0
  tags:
      - RHEL-07-020260
      - packaging

- name: "MEDIUM | RHEL-07-020270 | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
  block:
      - name: "MEDIUM | RHEL-07-020270 | AUDIT | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
        command: "grep '^{{ item }}:' /etc/passwd"
        check_mode: no
        failed_when: rhel_07_020270_audit.rc > 1
        changed_when: rhel_07_020270_audit.rc == 0
        register: rhel_07_020270_audit
        with_items: "{{ rhel7stig_unnecessary_accounts }}"

      - name: "MEDIUM | RHEL-07-020270 | PATCH | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
        user:
            name: "{{ item }}"
            state: absent
            remove: "{{ rhel7stig_remove_unnecessary_user_files }}"
        register: rhel_07_020270_patch
        with_items: "{{ rhel7stig_unnecessary_accounts }}"

      - name: "MEDIUM | RHEL-07-020270 | AUDIT | Re-parse /etc/passwd since it changed."
        include_tasks: parse_etc_passwd.yml
        vars:
            rhel7stig_passwd_tasks: "RHEL-07-020270"
        when: rhel_07_020270_patch is changed
  when: rhel_07_020270
  tags:
      - RHEL-07-020270

- name: "MEDIUM | RHEL-07-020320 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
  block:
      - name: "MEDIUM | RHEL-07-020320 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
        command: find "{{ item.mount }}" -xdev -nouser
        check_mode: no
        register: rhel_07_020320_audit
        failed_when: no
        changed_when: no
        when: item['device'].startswith('/dev') and not 'bind' in item['options']
        with_items: "{{ ansible_mounts }}"

      - name: "MEDIUM | RHEL-07-020320 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
        debug:
            msg: "Manual intervention is required -- missing owner on items in {{ item.item.mount }}: {{ item.stdout_lines | join(', ') }}"
        changed_when:
            - rhel7stig_audit_complex
        when:
            - item.stdout_lines is defined
            - item.stdout_lines | length > 0
        with_items: "{{ rhel_07_020320_audit.results }}"
  when:
      - rhel_07_020320
      - rhel7stig_complex
  tags:
      - RHEL-07-020320
      - complexity-high

- name: "MEDIUM | RHEL-07-020330 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid group owner."
  block:
      - name: "MEDIUM | RHEL-07-020330 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid group owner."
        command: find "{{ item.mount }}" -xdev -nogroup
        check_mode: no
        register: rhel_07_020330_audit
        failed_when: no
        changed_when: no
        when: item['device'].startswith('/dev') and not 'bind' in item['options']
        with_items: "{{ ansible_mounts }}"

      - name: "MEDIUM | RHEL-07-020330 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid group owner."
        debug:
            msg: "Manual intervention is required -- missing group on items in {{ item.item.mount }}: {{ item.stdout_lines | join(', ') }}"
        changed_when:
            - rhel7stig_audit_complex
        when:
            - item.stdout_lines is defined
            - item.stdout_lines | length > 0
        with_items: "{{ rhel_07_020330_audit.results }}"
  when:
      - rhel_07_020330
      - rhel7stig_complex
  tags:
      - RHEL-07-020330
      - complexity-high

- name: "MEDIUM | RHEL-07-020600 | The Red Hat Enterprise Linux operating system must be configured so that all local interactive users have a home directory assigned in the /etc/passwd file."
  block:
      - name: capture audit task for missing homedirs
        block: &r7s_homedir_audit
            - name: "MEDIUM | RHEL-07-020600 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive users have a home directory assigned in the /etc/passwd file."
              shell: set -o pipefail ; pwck -r | grep -P {{ ld_regex | quote }}
              check_mode: no
              register: rhel7stig_users_missing_home
              changed_when: rhel7stig_07_20600_audit | length > 0
              # failed_when: 0: success, 1: no grep match, 2: pwck found something
              failed_when: rhel7stig_users_missing_home.rc not in [0,1,2]
        when:
            - rhel7stig_disruptive
        tags:
            - disruption-high

      ### NOTE: due to https://github.com/ansible/ansible/issues/24862 This is a shell command, and is quite frankly less than ideal.
      - name: "MEDIUM | RHEL-07-020600 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive users have a home directory assigned in the /etc/passwd file."
        command: "mkhomedir_helper {{ item }}"
        check_mode: "{{ rhel7stig_disruptive_check_mode }}"
        with_items: "{{ rhel7stig_07_20600_audit | map(attribute='id') | list }}"
        when:
            - rhel7stig_users_missing_home is changed
            - rhel7stig_disruptive  # not technically required
        tags:
            - disruption-high

      ### NOTE: Now we need to address that SELINUX will not let mkhomedir_helper create home directories for UUID < 500, so the ftp user will still show up in a pwck. Not sure this is needed, as the ftp user is removed in rhel7stig_unnecessary_accounts. However these next two tasks won't make any changes if the system accounts are removed previously in RHEL-07-020270.
      ### ^ Likely doesn't matter as 020620 defines "local interactive users" as those w/ uid 1000-4999
      - name: replay audit task
        block: *r7s_homedir_audit
        when:
            - rhel7stig_complex
        tags:
            - complexity-high

      # CAUTION: debug loops don't show changed since 2.4:
      # Fix: https://github.com/ansible/ansible/pull/59958
      - name: "MEDIUM | RHEL-07-020600 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive users have a home directory assigned in the /etc/passwd file."
        debug: msg="You will need to mkdir -p {{ item }} and chown properly to the correct owner and group."
        with_items: "{{ rhel7stig_07_20600_audit | map(attribute='dir') | list }}"
        changed_when: rhel7stig_audit_complex
        when:
            - rhel7stig_users_missing_home is changed
            - rhel7stig_complex  # not technically required
        tags:
            - complexity-high
  vars:
      ld_regex: >-
          ^user '(?P<user>.*)': directory '(?P<dir>.*)' does not exist$
      ld_users: "{{ rhel7stig_users_missing_home.stdout_lines | map('regex_replace', ld_regex, '\\g<user>') | list }}"
      rhel7stig_07_20600_audit: "{{ rhel7stig_passwd | selectattr('uid', '>=', 1000) | selectattr('id', 'in', ld_users) | list }}"
  when:
      - rhel_07_020600
  tags:
      - RHEL-07-020600


- name: "MEDIUM | RHEL-07-020610 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user accounts, upon creation, are assigned a home directory."
  lineinfile:
      dest: /etc/login.defs
      regexp: ^#?CREATE_HOME
      line: "CREATE_HOME {{ rhel7stig_login_defaults.create_home | default('yes') }}"
  when: rhel_07_020610
  tags:
      - RHEL-07-020610
      - login
      - home

- name: "MEDIUM | RHEL-07-020620 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories are defined in the /etc/passwd file."
  file:
      path: "{{ item.dir }}"
      state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel_07_020620
      - item.uid >= 1000
      - item.uid != 65534
  tags:
      - RHEL-07-020620

- name: "MEDIUM | RHEL-07-020630 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories have mode 0750 or less permissive."
  file:
      path: "{{ item.dir }}"
      mode: "{{ rhel7stig_homedir_mode }}"
      state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel_07_020630
      - item.uid >= 1000
      - item.uid != 65534
  tags:
      - RHEL-07-020630

- name: "MEDIUM | RHEL-07-020640 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories are owned by their respective users."
  file:
      path: "{{ item.dir }}"
      owner: "{{ item.id }}"
      state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel_07_020640
      - item.uid >= 1000
      - item.uid != 65534
  tags:
      - RHEL-07-020640

- name: "MEDIUM | RHEL-07-020650 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories are group-owned by the home directory owners primary group."
  file:
      path: "{{ item.dir }}"
      group: "{{ item.gid }}"
      state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel_07_020650
      - item.uid >= 1000
      - item.uid != 65534
  tags:
      - RHEL-07-020650

- name: "MEDIUM | RHEL-07-020660 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are owned by the owner of the home directory."
  block:
      - name: "MEDIUM | RHEL-07-020660 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are owned by the owner of the home directory."
        command: "{{ find_command_base }} -print -quit"
        check_mode: no
        changed_when: rhel_07_020660_audit.stdout != ""
        register: rhel_07_020660_audit
        with_items: "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - this_item.uid >= 1000
            - this_item.uid != 65534
        vars:
            this_item: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020660 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are owned by the owner of the home directory."
        command: "{{ find_command_base }} -exec chown {{ this_item.uid }} {} +"
        with_items: "{{ rhel_07_020660_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - item is changed
        vars:
            this_item: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1
             ( -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*" -type f ) -o
             -not -user {{ this_item.uid }}'
  when: rhel_07_020660
  tags:
      - RHEL-07-020660

- name: "MEDIUM | RHEL-07-020670 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are group-owned by a group of which the home directory owner is a member."
  block:
      - name: "MEDIUM | RHEL-07-020670 | AUDIT | Get all GIDs for each user."
        command: id -G "{{ item.id }}"
        check_mode: no
        changed_when: no
        register: rhel_07_all_gid_audit
        with_items: "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"

      - name: "MEDIUM | RHEL-07-020670 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are group-owned by a group of which the home directory owner is a member."
        command: "{{ find_command_base }} -print -quit"
        check_mode: no
        changed_when: rhel_07_020670_audit.stdout != ""
        register: rhel_07_020670_audit
        with_items: "{{ rhel_07_all_gid_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - this_item.uid >= 1000
            - this_item.uid != 65534
        vars:
            this_item: "{{ item.item }}"
            this_result: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020670 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are group-owned by a group of which the home directory owner is a member."
        command: "{{ find_command_base }} -exec chgrp {{ this_item.gid }} {} +"
        with_items: "{{ rhel_07_020670_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - item is changed
        vars:
            this_item: "{{ item.item.item }}"
            this_result: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1
              ( -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*" -type f ) -o
              -not -group {{ this_result.stdout.split(" ") | join(" -not -group ") }}'
  when: rhel_07_020670
  tags:
      - RHEL-07-020670

- name: "MEDIUM | RHEL-07-020680 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
  block:
      - name: "MEDIUM | RHEL-07-020680 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
        stat:
            path: "{{ item }}"
        with_items: "{{ rhel7stig_passwd | selectattr('uid', '>=', 1000) | selectattr('uid', '!=', 65534) | map(attribute='dir') | list }}"
        register: rhel_07_020680_audit

      - name: "MEDIUM | RHEL-07-020680 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
        command: find -H {{ item.0 | quote }} -not -type l -perm /027
        check_mode: no
        register: rhel_07_020680_patch_audit
        changed_when: rhel_07_020680_patch_audit.stdout != ""
        when:
            - ansible_check_mode
            - item.1.exists
        with_together:
            - "{{ rhel_07_020680_audit.results | map(attribute='item') | list }}"
            - "{{ rhel_07_020680_audit.results | map(attribute='stat') | list }}"
        loop_control:
            label: "{{ item.0 }}"

      - name: "MEDIUM | RHEL-07-020680 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
        file:
            path: "{{ item.0 }}"
            recurse: yes
            follow: False
            mode: a-st,g-w,o-rwx
        register: rhel_07_020680_patch
        when:
            - not ansible_check_mode
            - item.1.exists
        with_together:
            - "{{ rhel_07_020680_audit.results | map(attribute='item') | list }}"
            - "{{ rhel_07_020680_audit.results | map(attribute='stat') | list }}"
        loop_control:
            label: "{{ item.0 }}"

      # set default ACLs so the homedir has an effective umask of 0027
      - name: "MEDIUM | RHEL-07-020680 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
        acl:
            path: "{{ item.0 }}"
            default: yes
            state: present
            recursive: yes
            etype: "{{ item.1.etype }}"
            permissions: "{{ item.1.mode }}"
        when: not rhel7stig_system_is_container
        with_nested:
            - "{{ (ansible_check_mode | ternary(rhel_07_020680_patch_audit, rhel_07_020680_patch)).results |
              rejectattr('skipped', 'defined') | map(attribute='item') | map('first') | list }}"
            -
                - etype: group
                  mode: rx
                - etype: other
                  mode: '0'
  when: rhel_07_020680
  tags:
      - RHEL-07-020680

- name: "MEDIUM | RHEL-07-020690 | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for interactive users are owned by the home directory user or root."
  block:
      - name: "MEDIUM | RHEL-07-020690 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for interactive users are owned by the home directory user or root."
        command: "{{ find_command_base }} -print -quit"
        check_mode: no
        changed_when: rhel_07_020690_audit.stdout != ""
        register: rhel_07_020690_audit
        with_items: "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - this_item.uid >= 1000
            - this_item.uid != 65534
        vars:
            this_item: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020690 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for interactive users are owned by the home directory user or root."
        command: "{{ find_command_base }} -exec chown {{ this_item.uid }} {} +"
        with_items: "{{ rhel_07_020690_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - item is changed
        vars:
            this_item: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1 -type f
              -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*"
              -not ( -user {{ this_item.uid }} -o -user root )'
  when: rhel_07_020690
  tags:
      - RHEL-07-020690

- name: "MEDIUM | RHEL-07-020700 | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for local interactive users are be group-owned by the users primary group or root."
  block:
      - name: "MEDIUM | RHEL-07-020700 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for local interactive users are be group-owned by the users primary group or root."
        command: "{{ find_command_base }} -print -quit"
        check_mode: no
        changed_when: rhel_07_020700_audit.stdout != ""
        register: rhel_07_020700_audit
        with_items: "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - this_item.uid >= 1000
            - this_item.uid != 65534
        vars:
            this_item: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020700 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for local interactive users are be group-owned by the users primary group or root."
        command: "{{ find_command_base }} -exec chgrp {{ this_item.gid }} {} +"
        with_items: "{{ rhel_07_020700_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - item is changed
        vars:
            this_item: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1 -type f
              -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*"
              -not ( -group {{ this_item.gid }} -o -group root )'
  when: rhel_07_020700
  tags:
      - RHEL-07-020700

- name: "MEDIUM | RHEL-07-020710 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files have mode 0740 or less permissive."
  command: "true"
  changed_when: no
  when: rhel_07_020710
  tags:
      - RHEL-07-020710
      - notimplemented

- name: "MEDIUM | RHEL-07-020720 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files executable search paths contain only paths that resolve to the users home directory."
  command: "true"
  changed_when: no
  when: rhel_07_020720
  tags:
      - RHEL-07-020720
      - notimplemented

- name: "MEDIUM | RHEL-07-020730 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that local initialization files do not execute world-writable programs."
  command: "true"
  changed_when: no
  when: rhel_07_020730
  tags:
      - RHEL-07-020730
      - notimplemented


- name: "MEDIUM | RHEL-07-020900 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
  setup:
      gather_subset: selinux,!min,!all
      filter: ansible_selinux
  when:
      - rhel_07_020900
      - rhel7stig_complex
      - ansible_selinux is not defined
  tags:
      - RHEL-07-020900
      - complexity-high

- name: "MEDIUM | RHEL-07-020900 | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
  block:
      - name: "MEDIUM | RHEL-07-020900 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
        command: find {{ rhel7stig_local_mounts | join(' ') }} -xdev ( -context *:device_t:* -o -context *:unlabeled_t:* ) ( -type c -o -type b ) -printf '%p %Z\n'
        changed_when: no
        check_mode: no
        register: rhel_07_020900_audit

      - name: "MEDIUM | RHEL-07-020900 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
        debug:
            msg: "{{ rhel_07_020900_audit.stdout_lines }}"
        changed_when:
            - rhel7stig_audit_complex
        when:
            - rhel_07_020900_audit.stdout_lines | length > 0

  when:
      - rhel_07_020900
      - rhel7stig_complex
      - ansible_selinux.status == "enabled"
  tags:
      - RHEL-07-020900
      - complexity-high

- name: "MEDIUM | RHEL-07-021000 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that file systems containing user home directories are mounted to prevent files with the setuid and setgid bit set from being executed."
  mount:
      path: /home
      state: mounted
      src: "{{ \"UUID={}\".format(home_mount.uuid) if rhel7stig_using_uuid_fstab else home_mount.device }}"
      fstype: "{{ home_mount.fstype }}"
      opts: "{{ home_mount.options }},nosuid"
  when:
      - rhel_07_021000
      - ansible_mounts | selectattr('mount', 'match', '^/home$') | list | length != 0
      - "'nosuid' not in home_mount.options"
  vars:
      home_mount: "{{ ansible_mounts | json_query('[?mount == `/home`] | [0]') }}"
  tags:
      - RHEL-07-021000

- name: "MEDIUM | RHEL-07-021010 | PATCH | The Red Hat Enterprise Linux operating system must prevent files with the setuid and setgid bit set from being executed on file systems that are used with removable media."
  command: "true"
  changed_when: no
  when: rhel_07_021010
  tags:
      - RHEL-07-021010
      - notimplemented

- name: "MEDIUM | RHEL-07-021020 | PATCH | The Red Hat Enterprise Linux operating system must prevent files with the setuid and setgid bit set from being executed on file systems that are being imported via Network File System (NFS)."
  mount:
      path: "{{ item }}"
      src: "{{ ansible_mounts | json_query(device_query) }}"
      fstype: "{{ ansible_mounts | json_query(fstype_query) }}"
      opts: "{{ ansible_mounts | json_query(options_query) }},nosuid"
      state: mounted
  vars:
      device_query: '[?mount == `{{ item }}`] | [0].device'
      fstype_query: '[?mount == `{{ item }}`] | [0].fstype'
      options_query: '[?mount == `{{ item }}`] | [0].options'
  with_items: "{{ rhel7stig_nfs_mounts }}"
  when:
      - rhel_07_021020
      - "'nosuid' not in (ansible_mounts | json_query(options_query))"
  tags:
      - RHEL-07-021020

- name: "MEDIUM | RHEL-07-021021 | PATCH | The Red Hat Enterprise Linux operating system must prevent binary files from being executed on file systems that are being imported via Network File System (NFS)."
  mount:
      path: "{{ item }}"
      src: "{{ ansible_mounts | json_query(device_query) }}"
      fstype: "{{ ansible_mounts | json_query(fstype_query) }}"
      opts: "{{ ansible_mounts | json_query(options_query) }},noexec"
      state: mounted
  vars:
      device_query: '[?mount == `{{ item }}`] | [0].device'
      fstype_query: '[?mount == `{{ item }}`] | [0].fstype'
      options_query: '[?mount == `{{ item }}`] | [0].options'
  with_items: "{{ rhel7stig_nfs_mounts }}"
  when:
      - rhel_07_021021
      - "'noexec' not in (ansible_mounts | json_query(options_query))"
  tags:
      - RHEL-07-021021

- name: "MEDIUM | RHEL-07-021030 | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are group-owned by root, sys, bin, or an application group."
  block:
      - name: "MEDIUM | RHEL-07-021030 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are group-owned by root, sys, bin, or an application group."
        command: find {{ rhel7stig_local_mounts | join(' ') }} -xdev -type d -perm -002 -gid +999
        changed_when: rhel_07_021030_audit.stdout != ""
        check_mode: no
        register: rhel_07_021030_audit

      - name: "MEDIUM | RHEL-07-021030 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are group-owned by root, sys, bin, or an application group."
        file:
            path: "{{ item }}"
            group: root
        check_mode: "{{ rhel7stig_disruptive_check_mode }}"
        with_items: "{{ rhel_07_021030_audit.stdout_lines }}"

  when:
      - rhel_07_021030
      - rhel7stig_disruptive
  tags:
      - RHEL-07-021030
      - disruption-high

- name: "MEDIUM | RHEL-07-021040 | PATCH | The Red Hat Enterprise Linux operating system must set the umask value to 077 for all local interactive user accounts."
  command: "true"
  changed_when: no
  when: rhel_07_021040
  tags:
      - RHEL-07-021040
      - notimplemented

- name: "MEDIUM | RHEL-07-021100 | PATCH | The Red Hat Enterprise Linux operating system must have cron logging implemented."
  lineinfile:
      path: /etc/rsyslog.conf
      state: present
      regexp: '^cron\.\*[ \t]+/var/log/cron$'
      line: 'cron.*                                                  /var/log/cron'
      insertafter: '#### RULES ####'
  register: result
  failed_when:
      - result is failed
      - result.rc != 257
  when: rhel_07_021100
  tags:
      - RHEL-07-021100

- name: |
        MEDIUM | RHEL-07-021110 | The Red Hat Enterprise Linux operating system must be configured so that the cron.allow file, if it exists, is owned by root.
        MEDIUM | RHEL-07-021120 | The Red Hat Enterprise Linux operating system must be configured so that the cron.allow file, if it exists, is group-owned by root.
  block:
      - name: "MEDIUM | RHEL-07-021110, RHEL-07-021120 | PATCH | Check if cron.allow file exists"
        stat:
            path: /etc/cron.allow
        register: cron_allow_file_check

      - name: "MEDIUM | RHEL-07-021110, RHEL-07-021120 | PATCH | Set cron.allow file owner and group-owner to root"
        file:
            dest: /etc/cron.allow
            state: file
            owner: root
            group: root
            mode: 0600
        when: cron_allow_file_check.stat.exists
  when:
      - rhel_07_021110
      - rhel_07_021120
  tags:
      - RHEL-07-021110
      - RHEL-07-021120
      - cron

- name: "MEDIUM | RHEL-07-021300 | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
  block:
      - name: "MEDIUM | RHEL-07-021300 | PATCH | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
        shell: "systemctl show kdump | grep LoadState | cut -d = -f 2"
        register: rhel_07_021300_kdump_service_status
        changed_when: no
        check_mode: no

      - name: "MEDIUM | RHEL-07-021300 | PATCH | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
        service:
            name: kdump
            enabled: no
            state: stopped
        when:
            - rhel_07_021300_kdump_service_status.stdout == "loaded"
            - not rhel7stig_kdump_required
  when: rhel_07_021300
  tags:
      - RHEL-07-021300

- name: "MEDIUM | RHEL-07-021620 | The Red Hat Enterprise Linux operating system must use a file integrity tool that is configured to use FIPS 140-2 approved cryptographic hashes for validating file contents and directories."
  block:
      - name: "Replace sha256+sha512 entries with sha512"
        replace:
            path: /etc/aide.conf
            regexp: '([A-Z]+ = .*)(sha256\+sha512)(.*)'
            replace: '\1sha512\3'
        register: rhel_07_021620_sha256_512_result
        notify: "{{ rhel7stig_aide_handler }}"

      - name: "Replace sha256 entries with sha512"
        replace:
            path: /etc/aide.conf
            regexp: '([A-Z]+ = .*)(sha256)(.*)'
            replace: '\1sha512\3'
        register: rhel_07_021620_sha256_result
        notify: "{{ rhel7stig_aide_handler }}"

  when: rhel_07_021620
  tags:
      - aide
      - RHEL-07-021620

- name: "MEDIUM | RHEL-07-021700 | PATCH | The Red Hat Enterprise Linux operating system must not allow removable media to be used as the boot loader unless approved."
  command: "true"
  changed_when: no
  when: rhel_07_021700
  tags:
      - RHEL-07-021700
      - notimplemented

- name: "MEDIUM | RHEL-07-030010 | PATCH | The Red Hat Enterprise Linux operating system must shut down upon audit processing failure, unless availability is an overriding concern. If availability is a concern, the system must alert the designated staff (System Administrator [SA] and Information System Security Officer [ISSO] at a minimum) in the event of an audit processing failure."
  lineinfile:
      path: /etc/audit/rules.d/audit.rules
      regexp: "^-f "
      line: "-f {{ rhel7stig_auditd_failure_flag }}"
  notify: update running audit failure mode
  when: rhel_07_030010
  tags:
      - auditd
      - RHEL-07-030010

- name: "MEDIUM | RHEL-07-030200 | The Red Hat Enterprise Linux operating system must be configured to use the au-remote plugin."
  lineinfile:
      path: "{{ item }}"
      regexp: (?i)^ *active *=
      line: active = yes
  with_items:
      - "{{ rhel7stig_audisp_config_path }}/plugins.d/au-remote.conf"
  when:
      - rhel_07_030200
  tags:
      - auditd
      - RHEL-07-030200

- name: "MEDIUM | RHEL-07-030300 | PATCH | The Red Hat Enterprise Linux operating system must off-load audit records onto a different system or media from the system being audited."
  lineinfile:
      path: "{{ rhel7stig_audisp_config_path }}/audisp-remote.conf"
      regexp: ^remote_server *=
      line: remote_server = {{ rhel7stig_audisp_remote_server }}
  when: rhel_07_030300 and rhel7stig_audisp_remote_server
  tags:
      - auditd
      - RHEL-07-030300

- name: "MEDIUM | RHEL-07-030310 | PATCH | The Red Hat Enterprise Linux operating system must encrypt the transfer of audit records off-loaded onto a different system or media from the system being audited."
  lineinfile:
      path: "{{ rhel7stig_audisp_config_path }}/audisp-remote.conf"
      regexp: ^enable_krb5 +=
      line: enable_krb5 = yes
  when: rhel_07_030310
  tags:
      - auditd
      - RHEL-07-030310

- name: "MEDIUM | RHEL-07-030320 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the audit system takes appropriate action when the audit storage volume is full."
  lineinfile:
      path: "{{ rhel7stig_audisp_config_path }}/audisp-remote.conf"
      regexp: ^disk_full_action +=
      line: "disk_full_action = {{ rhel7stig_audisp_disk_full_action }}"
  when: rhel_07_030320
  tags:
      - auditd
      - RHEL-07-030320

- name: "MEDIUM | RHEL-07-030321 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the audit system takes appropriate action when there is an error sending audit records to a remote system."
  lineinfile:
      path: "{{ rhel7stig_audisp_config_path }}/audisp-remote.conf"
      regexp: ^network_failure_action +=
      line: "network_failure_action = {{ rhel7stig_audisp_network_failure_action }}"
  when: rhel_07_030321
  tags:
      - auditd
      - RHEL-07-030321

- name: "MEDIUM | RHEL-07-030330 | PATCH | The Red Hat Enterprise Linux operating system must initiate an action to notify the System Administrator (SA) and Information System Security Officer ISSO, at a minimum, when allocated audit record storage volume reaches 75% of the repository maximum audit record storage capacity."
  lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^space_left +=
      line: "space_left = {{ [rhel7stig_auditd_space_left | int, 51] | max }}"
  when: rhel_07_030330
  tags:
      - auditd
      - RHEL-07-030330

- name: "MEDIUM | RHEL-07-030340 | PATCH | The Red Hat Enterprise Linux operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) via email when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^space_left_action +=
      line: "space_left_action = email"
  register: rhel7stig_auditd_space_left_action_result
  failed_when:
      - rhel7stig_auditd_space_left_action_result is failed
      - rhel7stig_auditd_space_left_action_result.rc != 257
  when: rhel_07_030340
  tags:
      - auditd
      - RHEL-07-030340

- name: "MEDIUM | RHEL-07-030350 | PATCH | The Red Hat Enterprise Linux operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^action_mail_acct +=
      line: "action_mail_acct = {{ rhel7stig_auditd_mail_acct }}"
  register: rhel7stig_auditd_action_mail_acct_result
  failed_when:
      - rhel7stig_auditd_action_mail_acct_result is failed
      - rhel7stig_auditd_action_mail_acct_result.rc != 257
  when: rhel_07_030350
  tags:
      - auditd
      - RHEL-07-030350

- name: "MEDIUM | RHEL-07-030360 | The Red Hat Enterprise Linux operating system must audit all executions of privileged functions."
  block:
      - name: "MEDIUM | RHEL-07-030360 | PATCH | The Red Hat Enterprise Linux operating system must audit all executions of privileged functions. (Delete obsolete suid/sgid rules)"
        file:
            path: "/etc/audit/rules.d/rhel7stig_suid_sgid_commands.rules"
            state: absent

      - name: "MEDIUM | RHEL-07-030360 | PATCH | The Red Hat Enterprise Linux operating system must audit all executions of privileged functions. (Audit rules for execve calls)"
        lineinfile:
            path: "/etc/audit/rules.d/rhel7stig_execve_calls.rules"
            create: yes
            owner: root
            group: root
            mode: 0600
            line: "{{ item }}"
            state: present
        with_items:
            - "-a always,exit -F arch=b32 -S execve -C uid!=euid -F euid=0 -k setuid"
            - "-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -k setuid"
            - "-a always,exit -F arch=b32 -S execve -C gid!=egid -F egid=0 -k setgid"
            - "-a always,exit -F arch=b64 -S execve -C gid!=egid -F egid=0 -k setgid"
        notify: restart auditd

  when: rhel_07_030360
  tags:
      - audit-rules
      - RHEL-07-030360

- name: "MEDIUM | Auditing system calls"
  include_tasks: audit_system_call.yml
  with_items:
      - id: "030370"
        call: "chown"
        key: "perm_mod"
      - id: "030380"
        call: "fchown"
        key: "perm_mod"
      - id: "030390"
        call: "lchown"
        key: "perm_mod"
      - id: "030400"
        call: "fchownat"
        key: "perm_mod"
      - id: "030410"
        call: "chmod"
        key: "perm_mod"
      - id: "030420"
        call: "fchmod"
        key: "perm_mod"
      - id: "030430"
        call: "fchmodat"
        key: "perm_mod"
      - id: "030440"
        call: "setxattr"
        key: "perm_mod"
      - id: "030450"
        call: "fsetxattr"
        key: "perm_mod"
      - id: "030460"
        call: "lsetxattr"
        key: "perm_mod"
      - id: "030470"
        call: "removexattr"
        key: "perm_mod"
      - id: "030480"
        call: "fremovexattr"
        key: "perm_mod"
      - id: "030490"
        call: "lremovexattr"
        key: "perm_mod"
      - id: "030500"
        call: "creat"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030500"
        call: "creat"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030510"
        call: "open"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030510"
        call: "open"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030520"
        call: "openat"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030520"
        call: "openat"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030530"
        call: "open_by_handle_at"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030530"
        call: "open_by_handle_at"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030540"
        call: "truncate"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030540"
        call: "truncate"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030550"
        call: "ftruncate"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030550"
        call: "ftruncate"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030740"
        call: "mount"
        key: "privileged-mount"
      - id: "030819"
        call: "create_module"
        include_all_auids: yes
        key: "module-change"
      - id: "030820"
        call: "init_module"
        include_all_auids: yes
        key: "module-change"
      - id: "030821"
        call: "finit_module"
        include_all_auids: yes
        key: "module-change"
      - id: "030830"
        call: "delete_module"
        include_all_auids: yes
        key: "module-change"
      - id: "030880"
        call: "rename"
        key: "delete"
      - id: "030890"
        call: "renameat"
        key: "delete"
      - id: "030900"
        call: "rmdir"
        key: "delete"
      - id: "030910"
        call: "unlink"
        key: "delete"
      - id: "030920"
        call: "unlinkat"
        key: "delete"
  tags:
      - audit-rules

- name: "MEDIUM | Auditing commands"
  include_tasks: audit_command.yml
  with_items:
      - id: "030560"
        path: "/usr/sbin/semanage"
        key: "privileged-priv_change"
      - id: "030570"
        path: "/usr/sbin/setsebool"
        key: "privileged-priv_change"
      - id: "030580"
        path: "/usr/bin/chcon"
        key: "privileged-priv_change"
      - id: "030590"
        path: "/usr/sbin/setfiles"
        key: "privileged-priv_change"
      - id: "030630"
        path: "/usr/bin/passwd"
        key: "privileged-passwd"
      - id: "030640"
        path: "/usr/sbin/unix_chkpwd"
        key: "privileged-passwd"
      - id: "030650"
        path: "/usr/bin/gpasswd"
        key: "privileged-passwd"
      - id: "030660"
        path: "/usr/bin/chage"
        key: "privileged-passwd"
      - id: "030670"
        path: "/usr/sbin/userhelper"
        key: "privileged-passwd"
      - id: "030680"
        path: "/usr/bin/su"
        key: "privileged-priv_change"
      - id: "030690"
        path: "/usr/bin/sudo"
        key: "privileged-priv_change"
      - id: "030710"
        path: "/usr/bin/newgrp"
        key: "privileged-priv_change"
      - id: "030720"
        path: "/usr/bin/chsh"
        key: "privileged-priv_change"
      - id: "030740"
        path: "/usr/bin/mount"
        key: "privileged-mount"
      - id: "030750"
        path: "/usr/bin/umount"
        key: "privileged-mount"
      - id: "030760"
        path: "/usr/sbin/postdrop"
        key: "privileged-postfix"
      - id: "030770"
        path: "/usr/sbin/postqueue"
        key: "privileged-postfix"
      - id: "030780"
        path: "/usr/libexec/openssh/ssh-keysign"
        key: "privileged-ssh"
      - id: "030800"
        path: "/usr/bin/crontab"
        key: "privileged-cron"
      - id: "030810"
        path: "/usr/sbin/pam_timestamp_check"
        key: "privileged-pam"
      - id: "030840"
        path: "/usr/bin/kmod"
        trivial: yes
        key: "module-change"
  tags:
      - audit-rules

- name: "MEDIUM | Auditing files"
  include_tasks: audit_file.yml
  with_items:
      - id: "030610"
        path: "/var/run/faillock"
        description: "unsuccessful account access events"
        key: "logins"
      - id: "030620"
        path: "/var/log/lastlog"
        description: "successful account access events"
        key: "logins"
      - id: "030700"
        path: "/etc/sudoers"
        description: "modifications to sudoers"
        key: "privileged-actions"
      - id: "030700"
        path: "/etc/sudoers.d/"
        description: "modifications to sudoers"
        key: "privileged-actions"
      - id: "030870"
        path: "/etc/passwd"
        description: "account creations, modifications, disabling, and termination events that affect /etc/passwd"
        key: "identity"
      - id: "030871"
        path: "/etc/group"
        description: "account creations, modifications, disabling, and termination events that affect /etc/group"
        key: "identity"
      - id: "030872"
        path: "/etc/gshadow"
        description: "account creations, modifications, disabling, and termination events that affect /etc/gshadow"
        key: "identity"
      - id: "030873"
        path: "/etc/shadow"
        description: "account creations, modifications, disabling, and termination events that affect /etc/shadow"
        key: "identity"
      - id: "030874"
        path: "/etc/security/opasswd"
        description: "account creations, modifications, disabling, and termination events that affect /etc/security/opasswd"
        key: "identity"
  tags:
      - audit-rules

- name: "MEDIUM | RHEL-07-031000 | PATCH | The Red Hat Enterprise Linux operating system must send rsyslog output to a log aggregation server."
  blockinfile:
      path: /etc/rsyslog.conf
      state: present
      block: |
          $ActionQueueFileName rhel-07-031000  # unique name prefix for spool files
          $ActionQueueMaxDiskSpace 1g    # 1gb space limit (use as much as possible)
          $ActionQueueSaveOnShutdown on  # save messages to disk on shutdown
          $ActionQueueType LinkedList    # run asynchronously
          $ActionResumeRetryCount -1     # infinite retries if host is down
          # remote host is: name/ip:port, e.g. 192.168.0.1:514, port optional
          *.* @@{{ rhel7stig_log_aggregation_server }}
      insertafter: EOF
  register: result
  failed_when:
      - result is failed
      - result.rc != 257
  when:
      - rhel_07_031000
      - rhel7stig_log_aggregation_server is defined
  tags:
      - RHEL-07-031000
      - rsyslog

- name: "MEDIUM | RHEL-07-031010 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the rsyslog daemon does not accept log messages from other servers unless the server is being used for log aggregation."
  replace:
      path: /etc/rsyslog.conf
      regexp: '({{ item }})'
      replace: '# \1'
  with_items:
      - '^(\$ModLoad imtcp)'
      - '^(\$ModLoad imudp)'
      - '^(\$ModLoad imrelp)'
      - '^(\$UDPServerRun)'
      - '^(\$InputTCPServerRun)'
  when:
      - rhel_07_031010
      - not rhel7stig_system_is_log_aggregator
  register: result
  failed_when:
      - result is failed
      - result.rc != 257
  tags:
      - RHEL-07-031010
      - rsyslog

- name: "MEDIUM | RHEL-07-040100 | PATCH | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
  command: "true"
  changed_when: no
  when: rhel_07_040100
  tags:
      - RHEL-07-040100
      - notimplemented

- name: "MEDIUM | RHEL-07-040110 | PATCH | The Red Hat Enterprise Linux operating system must use a FIPS 140-2 approved cryptographic algorithm for SSH communications."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?Ciphers"
      line: Ciphers aes128-ctr,aes192-ctr,aes256-ctr
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040110
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040110
      - ssh

- name: "MEDIUM | RHEL-07-040160 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with a communication session are terminated at the end of the session or after 10 minutes of inactivity from the user at a command prompt, except to fulfill documented and validated mission requirements."
  blockinfile:
      create: yes
      mode: 0644
      dest: "{{ item.dest }}"
      state: "{{ item.state }}"
      marker: "# {mark} ANSIBLE MANAGED"
      block: |
        # Set session timeout - STIG ID RHEL-07-040160
        TMOUT={{ rhel7stig_shell_session_timeout.timeout }}
        readonly TMOUT
        export TMOUT
  with_items:
      - dest: "{{ rhel7stig_shell_session_timeout.file }}"
        state: present
      - dest: /etc/profile
        state: "{{ (rhel7stig_shell_session_timeout.file == '/etc/profile') | ternary('present', 'absent') }}"
  when: rhel_07_040160
  tags:
      - RHEL-07-040160
      - profile

- name: "MEDIUM | RHEL-07-040170 | PATCH | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner immediately prior to, or as part of, remote access logon prompts."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?Banner"
      line: Banner /etc/issue
      validate: /usr/sbin/sshd -tf %s
  notify: restart sshd
  when:
      - rhel_07_040170
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040170
      - ssh
      - dod_logon_banner

- name: "MEDIUM | RHEL-07-040180 | The Red Hat Enterprise Linux operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
  block:
      - name: "MEDIUM | RHEL-07-040180 | AUDIT | The Red Hat Enterprise Linux operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
        command: grep -i useldapauth /etc/sysconfig/authconfig
        check_mode: no
        register: rhel_07_040180_audit
        failed_when: no
        # todo only run this if authconfig is installed, or the file exists
        # do we want to create it?
        # failed_when: rhel_07_040180_audit.rc > 1
        changed_when:
            - rhel_07_040180_audit.rc == 1
            - not rhel7stig_skip_for_travis

      - name: "MEDIUM | RHEL-07-040180 | PATCH | The Red Hat Enterprise Linux operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
        command: "true"
        changed_when: no
        when: "'yes' in rhel_07_040180_audit.stdout"
  when: rhel_07_040180
  tags:
      - RHEL-07-040180
      - ldap
      - notimplemented

- name: "MEDIUM | RHEL-07-040190 | PATCH | The Red Hat Enterprise Linux operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) communications."
  command: "true"
  changed_when: no
  when: rhel_07_040190
  tags:
      - RHEL-07-040190
      - notimplemented

- name: "MEDIUM | RHEL-07-040200 | PATCH | The Red Hat Enterprise Linux operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) communications."
  command: "true"
  changed_when: no
  when: rhel_07_040200
  tags:
      - RHEL-07-040200
      - notimplemented

- name: "MEDIUM | RHEL-07-040201 | PATCH | The Red Hat Enterprise Linux operating system must implement virtual address space randomization."
  sysctl:
      name: kernel.randomize_va_space
      value: 2
      state: present
      reload: "{{ rhel7stig_sysctl_reload }}"
      sysctl_set: yes
      ignoreerrors: yes
  when: rhel_07_040201
  tags:
      - RHEL-07-040201
      - sysctl

- name: "MEDIUM | RHEL-07-040300 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all networked systems have SSH installed."
  yum:
      name:
          - openssh-server
      state: present
  when:
      - rhel_07_040300
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040300
      - ssh

- name: "MEDIUM | RHEL-07-040310 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all networked systems use SSH for confidentiality and integrity of transmitted and received information as well as information during preparation for transmission."
  service:
      name: sshd
      state: "{{ rhel7stig_service_started }}"
      enabled: yes
  when:
      - rhel_07_040310
      - rhel7stig_ssh_required
      - not (rhel7stig_system_is_chroot and rhel7stig_system_is_container)
  tags:
      - RHEL-07-040310
      - ssh

- name: "MEDIUM | RHEL-07-040320 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with SSH traffic are terminated at the end of the session or after 10 minutes of inactivity, except to fulfill documented and validated mission requirements."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?ClientAliveInterval"
      line: ClientAliveInterval {{ rhel7stig_ssh_session_timeout }}
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040320
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040320
      - ssh

- name: "MEDIUM | RHEL-07-040330 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using RSA rhosts authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?RhostsRSAAuthentication"
      line: RhostsRSAAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040330
      - rhel7stig_ssh_required
      - ansible_distribution_version is not version_compare('7.4', '>=')
  tags:
      - RHEL-07-040330
      - ssh

- name: "MEDIUM | RHEL-07-040340 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with SSH traffic terminate after a period of inactivity."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?ClientAliveCountMax"
      line: ClientAliveCountMax 0
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040340
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040340
      - ssh

- name: "MEDIUM | RHEL-07-040350 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using rhosts authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?IgnoreRhosts"
      line: IgnoreRhosts yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040350
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040350
      - ssh

- name: "MEDIUM | RHEL-07-040360 | PATCH | The Red Hat Enterprise Linux operating system must display the date and time of the last successful account logon upon an SSH logon."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?PrintLastLog"
      line: PrintLastLog yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040360
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040360
      - ssh

- name: "MEDIUM | RHEL-07-040370 | PATCH | The Red Hat Enterprise Linux operating system must not permit direct logons to the root account using remote access via SSH."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?PermitRootLogin"
      line: PermitRootLogin no
      insertafter: '(?i)^#?authentication'
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040370
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040370
      - ssh

- name: "MEDIUM | RHEL-07-040380 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using known hosts authentication."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?IgnoreUserKnownHosts"
      line: IgnoreUserKnownHosts yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040380
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040380
      - ssh

- name: "MEDIUM | RHEL-07-040400 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon is configured to only use Message Authentication Codes (MACs) employing FIPS 140-2 approved cryptographic hash algorithms."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?MACs"
      line: MACs hmac-sha2-256,hmac-sha2-512
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040400
      - rhel7stig_ssh_required
  tags:
      - ssh
      - RHEL-07-040400

- name: "MEDIUM | RHEL-07-040410 | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
  block:
      - name: "MEDIUM | RHEL-07-040410 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
        find:
            paths: /etc/ssh
            recurse: yes
            file_type: file
            patterns: 'ssh_host*_key.pub'
            hidden: true
        failed_when: no
        changed_when: no
        register: rhel_07_040410_audit

      - name: "MEDIUM | RHEL-07-040410 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
        file:
            dest: "{{ item.path }}"
            mode: a-stx,go-w
            state: file
        with_items: "{{ rhel_07_040410_audit.files | default([]) }}"
  when:
      - rhel_07_040410
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040410
      - ssh

- name: "MEDIUM | RHEL-07-040420 | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
  block:
      - name: "MEDIUM | RHEL-07-040420 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
        find:
            paths: /etc/ssh
            recurse: yes
            file_type: file
            patterns: 'ssh_host*_key'
            hidden: true
        failed_when: no
        changed_when: no
        register: rhel_07_040420_audit

      - name: "MEDIUM | RHEL-07-040420 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
        file:
            dest: "{{ item.path }}"
            mode: a-stx,go-w,o-r
            state: file
        with_items: "{{ rhel_07_040420_audit.files | default([]) }}"
  when:
      - rhel_07_040420
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040420
      - ssh

- name: "MEDIUM | RHEL-07-040430 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not permit Generic Security Service Application Program Interface (GSSAPI) authentication unless needed."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?GSSAPIAuthentication"
      line: GSSAPIAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040430
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040430
      - ssh

- name: "MEDIUM | RHEL-07-040440 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not permit Kerberos authentication unless needed."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?KerberosAuthentication"
      line: KerberosAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040440
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040440
      - ssh

- name: "MEDIUM | RHEL-07-040450 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon performs strict mode checking of home directory configuration files."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?StrictModes"
      line: StrictModes yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040450
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040450
      - ssh

- name: "MEDIUM | RHEL-07-040460 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon uses privilege separation."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?UsePrivilegeSeparation"
      line: UsePrivilegeSeparation sandbox
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040460
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040460
      - ssh

- name: "MEDIUM | RHEL-07-040470 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow compression or only allows compression after successful authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?Compression"
      line: Compression no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040470
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040470
      - ssh

- name: "MEDIUM | RHEL-07-040500 | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  block:
      - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        yum:
            name: chrony
            state: absent

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        yum:
            name: ntp
            state: present

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        lineinfile:
            create: yes
            dest: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].conf }}"
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
        notify: restart time service
        with_items: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].lines }}"
  when:
      - rhel7stig_time_service == 'ntpd'
      - rhel_07_040500
  tags:
      - RHEL-07-040500
      - ntp
      - ntpd

- name: "MEDIUM | RHEL-07-040500 | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  block:
      - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        yum:
            name: ntp
            state: absent

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        yum:
            name: chrony
            state: present

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        replace:
            dest: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].conf }}"
            regexp: '^server \S+( \w+)?$'
        notify: restart time service
  when:
      - rhel7stig_time_service == 'chronyd'
      - rhel_07_040500
  tags:
      - RHEL-07-040500
      - chronyd

- name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  blockinfile:
      insertbefore: BOF
      dest: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].conf }}"
      block: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].block }}"
      state: present
  notify: restart time service
  when:
      - rhel7stig_time_service == 'chronyd'
      - rhel_07_040500
  tags:
      - RHEL-07-040500
      - chronyd

- name: "MEDIUM | RHEL-07-040520 | PATCH | The Red Hat Enterprise Linux operating system must protect against or limit the effects of Denial of Service (DoS) attacks by validating the operating system is implementing rate-limiting measures on impacted network interfaces."
  yum:
      name: "{{ rhel7stig_firewall_service }}"
      state: present
  when: rhel_07_040520
  tags:
      - RHEL-07-040520
      - firewall

- name: "MEDIUM | RHEL-07-040520 | PATCH | The Red Hat Enterprise Linux operating system must enable an application firewall, if available."
  service:
      name: "{{ rhel7stig_firewall_service }}"
      state: "{{ rhel7stig_service_started }}"
      enabled: yes
  when:
      - rhel_07_040520
      - not (rhel7stig_system_is_chroot and rhel7stig_system_is_container)
  tags:
      - RHEL-07-040520
      - firewall

- name: "MEDIUM | RHEL-07-040610 | PATCH | The Red Hat Enterprise Linux operating system must not forward Internet Protocol version 4 (IPv4) source-routed packets."
  sysctl:
      name: net.ipv4.conf.all.accept_source_route
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040610
  tags:
      - RHEL-07-040610
      - ipv4

- name: "MEDIUM | RHEL-07-040620 | PATCH | The Red Hat Enterprise Linux operating system must not forward Internet Protocol version 4 (IPv4) source-routed packets by default."
  sysctl:
      name: net.ipv4.conf.default.accept_source_route
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040620
  tags:
      - RHEL-07-040620
      - ipv4

- name: "MEDIUM | RHEL-07-040630 | PATCH | The Red Hat Enterprise Linux operating system must not respond to Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) echoes sent to a broadcast address."
  sysctl:
      name: net.ipv4.icmp_echo_ignore_broadcasts
      state: present
      value: 1
      sysctl_set: yes
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040630
  tags:
      - RHEL-07-040630
      - ipv4

- name: "MEDIUM | RHEL-07-040640 | PATCH | The Red Hat Enterprise Linux operating system must prevent Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages from being accepted."
  sysctl:
      name: net.ipv4.conf.default.accept_redirects
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040640
  tags:
      - RHEL-07-040640
      - ipv4

- name: "MEDIUM | RHEL-07-040641 | PATCH | The Red Hat Enterprise Linux operating system must ignore Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages"
  sysctl:
      name: net.ipv4.conf.all.accept_redirects
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040641
  tags:
      - RHEL-07-040641
      - ipv4

- name: "MEDIUM | RHEL-07-040650 | PATCH |  The Red Hat Enterprise Linux operating system must not allow interfaces to perform Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects by default."
  sysctl:
      name: net.ipv4.conf.default.send_redirects
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040650
  tags:
      - RHEL-07-040650
      - ipv4

- name: "MEDIUM | RHEL-07-040660 | PATCH | The Red Hat Enterprise Linux operating system must not send Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects."
  sysctl:
      name: net.ipv4.conf.all.send_redirects
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040660
  tags:
      - RHEL-07-040660
      - ipv4

- name: "MEDIUM | RHEL-07-040670 | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
  block:
      - name: "MEDIUM | RHEL-07-040670 | PATCH | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
        shell: "ip link | grep -i promisc | cut -d ':' -f 2"
        check_mode: no
        failed_when: no
        changed_when: rhel_07_040670_promisc_check.stdout != ''
        ignore_errors: yes
        register: rhel_07_040670_promisc_check

      - name: "MEDIUM | RHEL-07-040670 | PATCH | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
        shell: "ip link set dev {{ item }} promisc off"
        with_items: "{{ rhel_07_040670_promisc_check.stdout_lines }}"

  when:
      - rhel_07_040670
      - not rhel7stig_net_promisc_mode_required
  tags:
      - RHEL-07-040670

- name: "MEDIUM | RHEL-07-040680 | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
  block:
      - name: "MEDIUM | RHEL-07-040680 | AUDIT | Check if postfix is installed."
        command: rpm -q postfix
        args:
            warn: no
        failed_when: no
        check_mode: no
        changed_when: no
        register: rhel_07_040680_rpm_audit

      - name: "MEDIUM | RHEL-07-040680 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
        command: "/usr/sbin/postconf -n smtpd_client_restrictions"
        check_mode: no
        changed_when: no
        register: rhel_07_040680_postconf_audit
        when: rhel_07_040680_rpm_audit.rc == 0

      - name: "MEDIUM | RHEL-07-040680 | PATCH | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
        command: "/usr/sbin/postconf -e 'smtpd_client_restrictions=permit_mynetworks, reject'"
        when:
            - rhel_07_040680_rpm_audit.rc == 0
            - rhel_07_040680_postconf_audit.stdout != 'smtpd_client_restrictions = permit_mynetworks, reject'
  when: rhel_07_040680
  tags:
      - RHEL-07-040680

- name: "MEDIUM | RHEL-07-040720 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that if the Trivial File Transfer Protocol (TFTP) server is required, the TFTP daemon is configured to operate in secure mode."
  lineinfile:
      path: /etc/xinetd.d/tftp
      regexp: "(?i)^.*server_args.*="
      line: "\tserver_args\t\t= -s /var/lib/tftpboot"
      insertafter: "\tserver\t\t\t="
      state: present
  register: result
  failed_when:
      - result is failed
      - result.rc != 257
  when:
      - rhel7stig_tftp_required
      - rhel_07_040720
  tags:
      - RHEL-07-040720

- name: "MEDIUM | RHEL-07-040730 | PATCH | The Red Hat Enterprise Linux operating system must not have an X Windows display manager installed unless approved."
  yum:
      name:
          - "{{ ansible_distribution_major_version is version_compare('8', '<') | ternary('@x11', '@base-x') }}"
          - xorg-x11-server-common
      state: absent
  check_mode: "{{ rhel7stig_disruptive_check_mode }}"
  when:
      - not rhel7stig_gui
      - rhel_07_040730
      - rhel7stig_disruptive
  tags:
      - RHEL-07-040730
      - disruption-high
      - x11
      - gui

- name: "MEDIUM | RHEL-07-040740 | PATCH | The Red Hat Enterprise Linux operating system must not be performing packet forwarding unless the system is a router."
  sysctl:
      name: net.ipv4.ip_forward
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when:
      - not rhel7stig_system_is_router
      - rhel_07_040740
  tags:
      - RHEL-07-040740
      - ipv4

- name: "MEDIUM | RHEL-07-040750 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the Network File System (NFS) is configured to use RPCSEC_GSS."
  command: "true"
  changed_when: no
  when: rhel_07_040750
  tags:
      - RHEL-07-040750
      - notimplemented

- name: "MEDIUM | RHEL-07-040810 | PATCH | The Red Hat Enterprise Linux operating system access control program must be configured to grant or deny system access to specific hosts and services."
  command: "true"
  changed_when: no
  when: rhel_07_040810
  tags:
      - RHEL-07-040810
      - notimplemented

- name: "MEDIUM | RHEL-07-040820 | PATCH | The Red Hat Enterprise Linux operating system must not have unauthorized IP tunnels configured."
  yum:
      name:
          - libreswan
      state: absent
  check_mode: "{{ rhel7stig_disruptive_check_mode }}"
  when:
      - rhel_07_040820
      - rhel7stig_disruptive
  tags:
      - RHEL-07-040820
      - disruption-high

- name: "MEDIUM | RHEL-07-040830 | PATCH | The Red Hat Enterprise Linux operating system must not forward IPv6 source-routed packets."
  sysctl:
      name: net.ipv6.conf.all.accept_source_route
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040830
  tags:
      - RHEL-07-040830
      - ipv6

- name: "MEDIUM | RHEL-07-041001 | The Red Hat Enterprise Linux operating system must have the required packages for multifactor authentication installed."
  yum:
      name: "{{ rhel7stig_mfa_package }}"
      state: present
  when: rhel_07_041001
  tags:
      - RHEL-07-041001
      - multifactor

- name: "MEDIUM | RHEL-07-041002 | The Red Hat Enterprise Linux operating system must implement multifactor authentication for access to privileged accounts via pluggable authentication modules (PAM)."
  block:
      - name: "MEDIUM | RHEL-07-041002 | AUDIT | Check if pam service is configured in sssd file"
        command: 'grep -E "^\s*services\s*=.*pam" /etc/sssd/sssd.conf'
        check_mode: no
        changed_when:
            - sssd_services_check.rc == 1
            - not rhel7stig_skip_for_travis
        failed_when: no
        # todo: only run if sssd installed and config file present
        # failed_when: sssd_services_check.rc > 1
        register: sssd_services_check

      - name: "MEDIUM | RHEL-07-041002 | PATCH | The Red Hat Enterprise Linux operating system must implement multifactor authentication for access to privileged accounts via pluggable authentication modules (PAM)."
        debug:
            msg: "WARNING: SSSD is in use and /etc/sssd/sssd.conf is not configured to use the PAM service (services = nss, pam)"
        changed_when:
            - rhel7stig_audit_complex
        when: sssd_services_check.rc == 1
  when:
      - rhel7stig_auth_settings.use_sssd
      - rhel7stig_complex
      - rhel_07_041002
  tags:
      - RHEL-07-041002
      - complexity-high
      - sssd

- name: "MEDIUM | RHEL-07-041003 | The Red Hat Enterprise Linux operating system must implement certificate status checking for PKI authentication."
  replace:
      path: /etc/pam_pkcs11/pam_pkcs11.conf
      regexp: (?im)^([ \t]*cert_policy[ \t]*=(?:[^ \t\n]|[ \t](?!ocsp_on,))*?)(?:[ \t]ocsp_on,[ \t]*)?[ \t]*((?:[^,\n]|,(?![ \t]*ocsp_on,))*?)(?:,[ \t]*ocsp_on)?;$
      replace: '\1 ocsp_on, \2;'
  when:
      - rhel_07_041003
      - ansible_distribution_major_version is version_compare('8', '<')
  tags:
      - RHEL-07-041003

- name: "MEDIUM | RHEL-07-041010 | The Red Hat Enterprise Linux operating system must be configured so that all wireless network adapters are disabled."
  block:
      - name: "MEDIUM | RHEL-07-041010 | AUDIT | check if nmcli command is available"
        command: rpm -q NetworkManager
        args:
            warn: no
        check_mode: no
        changed_when: no
        register: rhel_07_nmcli_available
        failed_when: no

      - name: "MEDIUM | RHEL-07-041010 | AUDIT | check if wifi is enabled"
        command: nmcli radio wifi
        register: rhel_07_wifi_enabled
        check_mode: no
        changed_when: rhel_07_wifi_enabled.stdout != "disabled"
        when: rhel_07_nmcli_available.rc == 0

      - name: "MEDIUM | RHEL-07-041010 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all wireless network adapters are disabled."
        command: nmcli radio wifi off
        when: rhel_07_wifi_enabled is changed
  when: rhel_07_041010
  tags:
      - RHEL-07-041010
